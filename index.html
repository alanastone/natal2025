<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musical de Natal 2025</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎄</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            max-width: 100%;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #c41e3a;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        html {
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px;
            width: 100%;
            box-sizing: border-box;
        }

        .container.playlist-mode {
            padding: 15px;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            margin: 0;
        }

        .quick-links {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .quick-links h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #c41e3a;
        }

        .links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .link-card {
            background: #2c5530;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-decoration: none;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            font-weight: 500;
            font-size: 1rem;
        }

        .playlist-btn {
            border: none;
            cursor: pointer;
            width: 100%;
        }

        @media (hover: hover) {
            .link-card:hover, .playlist-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.2);
                background: #228B22;
                color: white;
            }
        }

        .songs-section {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .songs-section h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #c41e3a;
        }

        .songs-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .song-card {
            background: #2c5530;
            color: white;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        @media (hover: hover) {
            .song-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 15px 35px rgba(0,0,0,0.2);
                background: #228B22;
            }
        }

        @media (hover: hover) {
            .song-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                transition: left 0.5s;
            }

            .song-card:hover::before {
                left: 100%;
            }
        }

        .song-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .song-number {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .song-title {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .song-details {
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .song-details.active {
            display: block;
        }

        .song-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            gap: 15px;
        }

        .song-details h3 {
            color: #c41e3a;
            margin: 0;
            font-size: 1.6rem;
            flex: 1;
            text-align: center;
        }

        .audio-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .audio-item {
            background: #f8f9ff;
            padding: 10px;
            border-radius: 12px;
            border-left: 4px solid #c41e3a;
            margin-bottom: 10px;
        }

        .audio-item h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1rem;
            transition: color 0.3s ease;
        }

        .audio-item.playing h4 {
            color: #c41e3a;
        }


        .audio-item audio {
            display: none;
        }

        .custom-audio-player {
            width: 100%;
            background: #fff;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            margin-top: 8px;
        }

        .audio-progress-row {
            margin-bottom: 8px;
        }

        .progress-container {
            position: relative;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            cursor: pointer;
        }

        .progress-bar {
            height: 100%;
            background: #c41e3a;
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s;
        }

        .progress-thumb {
            position: absolute;
            top: 50%;
            width: 14px;
            height: 14px;
            background: #c41e3a;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .progress-thumb:active {
            cursor: grabbing;
        }

        .audio-controls-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .audio-time {
            font-size: 0.85rem;
            color: #666;
            min-width: 70px;
            flex-shrink: 0;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .play-btn, .custom-ff-btn, .custom-rw-btn {
            background: transparent;
            color: #666;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: color 0.2s ease;
            flex-shrink: 0;
            padding: 4px;
            user-select: none;
        }

        .play-btn {
            font-size: 1.2rem;
            background: #2c5530;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .play-btn.playing {
            background: #2c5530;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        @media (hover: hover) {
            .play-btn:hover {
                background: #228B22;
            }

            .play-btn.playing:hover {
                color: #c41e3a;
            }

            .custom-ff-btn:hover, .custom-rw-btn:hover {
                color: #c41e3a;
            }
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 70px;
            justify-content: flex-end;
            flex-shrink: 0;
        }

        .volume-btn {
            background: transparent;
            color: #666;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: color 0.2s ease;
            user-select: none;
            padding: 4px;
        }

        @media (hover: hover) {
            .volume-btn:hover {
                color: #c41e3a;
            }
        }

        .volume-slider {
            width: 50px;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        .volume-slider::-webkit-slider-thumb {
            appearance: none;
            width: 12px;
            height: 12px;
            background: #c41e3a;
            border-radius: 50%;
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #c41e3a;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }


        .drive-link {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-decoration: none;
            display: inline-block;
            margin-top: 20px;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        @media (hover: hover) {
            .drive-link:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
                color: white;
            }
        }

        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (hover: hover) {
            .back-btn:hover {
                background: #5a6268;
                transform: translateY(-2px);
            }
        }

        .stop-all-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (hover: hover) {
            .stop-all-btn:hover {
                background: #c82333;
                transform: translateY(-2px);
            }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header {
                margin-bottom: 10px;
                display: none;
            }

            .header h1 {
                font-size: 1.2rem;
                margin-bottom: 3px;
                line-height: 1.1;
            }

            .header p {
                font-size: 0.8rem;
                margin: 0;
            }

            .songs-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .song-card {
                padding: 15px;
            }

            .song-content {
                flex-direction: column;
                gap: 5px;
            }

            .song-number {
                font-size: 1.2rem;
            }

            .song-header {
                gap: 10px;
            }

            .song-details h3 {
                font-size: 1.3rem;
            }

            .back-btn, .stop-all-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .audio-list {
                gap: 12px;
            }

            .audio-item {
                padding: 15px;
            }

            .links-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }

            .link-card {
                padding: 12px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 320px) {
            .audio-controls-row {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }

            .audio-time {
                text-align: center;
                order: 1;
            }

            .audio-controls {
                order: 2;
                justify-content: center;
            }

            .volume-control {
                order: 3;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.1rem;
            }

            .header p {
                font-size: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .songs-section {
                padding: 20px;
            }

            .song-details {
                padding: 0px;
            }

            .audio-item {
                padding: 12px;
            }

            .playlist-section .audio-controls-row {
                flex-wrap: wrap;
                gap: 8px;
                justify-content: center;
            }

            .playlist-section .audio-time {
                order: 1;
                flex: 1;
                text-align: left;
                min-width: 80px;
            }

            .playlist-section .volume-control {
                order: 2;
                flex: 1;
                justify-content: flex-end;
                min-width: 80px;
            }

            .playlist-section .audio-controls {
                order: 3;
                flex-basis: 100%;
                justify-content: center;
                margin-top: 8px;
            }

            .current-song-title h4 {
                font-size: 0.9rem;
            }

            .playlist-header h2 {
                font-size: 1.3rem;
            }

            .playlist-section {
                padding: 20px;
            }

            .container.playlist-mode {
                padding: 10px;
            }

            .playlist-list {
                padding-right: 2px;
            }

            .playlist-list::-webkit-scrollbar {
                width: 4px;
            }
        }

        .playlist-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            margin: 0;
        }

        .playlist-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            gap: 15px;
            flex-shrink: 0;
        }

        .playlist-header h2 {
            color: #c41e3a;
            margin: 0;
            font-size: 1.6rem;
            flex: 1;
            text-align: center;
        }

        .playlist-player {
            background: #f8f9ff;
            padding: 10px;
            border-radius: 12px;
            border-left: 4px solid #c41e3a;
            margin-bottom: 25px;
            flex-shrink: 0;
        }

        .current-song-title {
            text-align: center;
            margin-bottom: 15px;
        }

        .current-song-title h4 {
            color: #c41e3a;
            font-size: 1rem;
            margin: 0;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .skip-prev-btn, .skip-next-btn {
            background: transparent;
            color: #666;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: color 0.2s ease;
            flex-shrink: 0;
            padding: 4px;
            user-select: none;
            font-family: monospace;
            font-weight: bold;
        }

        @media (hover: hover) {
            .skip-prev-btn:hover, .skip-next-btn:hover {
                color: #c41e3a;
            }
        }

        .playlist-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
            padding-right: 5px;
        }

        .playlist-list::-webkit-scrollbar {
            width: 6px;
        }

        .playlist-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .playlist-list::-webkit-scrollbar-thumb {
            background: #c41e3a;
            border-radius: 3px;
        }

        .playlist-list::-webkit-scrollbar-thumb:hover {
            background: #a01729;
        }

        .playlist-tracks-title {
            color: #c41e3a;
            margin-bottom: 15px;
            font-size: 1.2rem;
            margin-top: 0;
            flex-shrink: 0;
        }

        .playlist-tracks {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-bottom: 20px;
        }

        .playlist-track {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9ff;
            border-radius: 8px;
            transition: background 0.2s ease;
            gap: 15px;
            position: relative;
        }

        .playlist-track.current {
            background: #e8f5e8;
            border-left: 4px solid #2c5530;
        }

        .playlist-track.current .track-title {
            color: #2c5530;
            font-weight: bold;
        }


        .track-number {
            font-weight: bold;
            color: #666;
            min-width: 30px;
        }

        .track-title {
            flex: 1;
            color: #333;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .track-title:hover {
            background: rgba(196, 30, 58, 0.1);
            color: #c41e3a;
        }

        .track-status {
            font-size: 1.2rem;
            min-width: 25px;
            text-align: center;
        }

        .collapse-btn {
            background: transparent;
            border: none;
            font-size: 0.8rem;
            color: #666;
            cursor: pointer;
            padding: 4px;
            margin-left: auto;
            transition: transform 0.2s ease, color 0.2s ease;
            border-radius: 4px;
        }

        .collapse-btn:hover {
            color: #c41e3a;
            background: rgba(196, 30, 58, 0.1);
        }

        .collapse-btn.expanded {
            transform: rotate(180deg);
        }

        .sub-tracks {
            margin-left: 20px;
            margin-top: 8px;
            margin-bottom: 8px;
            position: relative;
        }

        .sub-tracks::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #c41e3a;
            border-radius: 1px;
        }

        .sub-track {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            background: #f0f2ff;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s ease;
            gap: 12px;
            margin-bottom: 4px;
            margin-left: 30px;
            position: relative;
        }

        .sub-track::before {
            content: '';
            position: absolute;
            left: -18px;
            top: 50%;
            width: 12px;
            height: 2px;
            background: #c41e3a;
            transform: translateY(-50%);
        }

        .sub-track:hover {
            background: #e0e7ff;
        }

        .sub-track.current {
            background: #e8f5e8;
            border-left: 4px solid #2c5530;
        }

        .sub-track.current .sub-track-title {
            color: #2c5530;
            font-weight: bold;
        }

        .sub-track-title {
            flex: 1;
            color: #555;
            font-size: 0.9rem;
        }

        @media (max-width: 380px) {
            .header h1 {
                font-size: 1rem;
            }

            .header p {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🎄 Musical de Natal 2025</h1>
        </div>

        <!-- Quick Links -->
        <div class="quick-links">
            <h2>Recursos Gerais</h2>
            <div class="links-grid">
                <!-- <a href="" target="_blank" class="link-card">
                    📄 Letras: Em breve
                </a>
                <a href="" target="_blank" class="link-card">
                    📅 Ensaios: Em breve
                </a> -->
                <a href="https://www.youtube.com/watch?v=mSXgE_SS2y8&list=PLWaADBxwbjQK9InaSgqfma39JAiug1v4r" target="_blank" class="link-card">
                    🎵 Playlist no Youtube
                </a>
                <button onclick="showPlaylist()" class="link-card playlist-btn">
                    🎧 Ouvir todas
                </button>
            </div>
        </div>

        <!-- Songs Section -->
        <div class="songs-section">
            <h2 id="songs-title">🎼 Músicas</h2>

            <div id="songs-grid" class="songs-grid">
                <!-- Songs will be generated dynamically from songs.json -->
            </div>

            <!-- Song Details Sections -->
            <div id="song-details-container">
                <!-- Song details will be generated dynamically from songs.json -->
            </div>
        </div>

        <!-- Playlist Section -->
        <div id="playlist-section" class="playlist-section" style="display: none;">
            <div class="playlist-header">
                <button class="back-btn" onclick="hidePlaylist()">←</button>
                <h2>🎧 Playlist</h2>
                <button class="stop-all-btn" onclick="stopPlaylist()">⏹</button>
            </div>

            <div class="playlist-player">
                <div class="current-song-title">
                    <h4 id="current-song-display">01 - Isaías 9</h4>
                </div>
                <audio id="playlist-audio" class="audioPlayer"></audio>
                <div class="custom-audio-player">
                    <div class="audio-progress-row">
                        <div class="progress-container">
                            <div class="progress-bar"></div>
                            <div class="progress-thumb"></div>
                        </div>
                    </div>
                    <div class="audio-controls-row">
                        <div class="audio-time">0:00 / 0:00</div>
                        <div class="audio-controls">
                            <button class="skip-prev-btn" onclick="skipToPrevious()">&lt;|</button>
                            <button class="custom-rw-btn">&lt;&lt;</button>
                            <button class="play-btn">▶</button>
                            <button class="custom-ff-btn">&gt;&gt;</button>
                            <button class="skip-next-btn" onclick="skipToNext()">|&gt;</button>
                        </div>
                        <div class="volume-control">
                            <button class="volume-btn">🔊</button>
                        </div>
                    </div>
                </div>
            </div>

            <h3 class="playlist-tracks-title">Lista de Reprodução</h3>
            <div class="playlist-list">
                <div class="playlist-tracks">
                    <!-- Playlist tracks will be generated dynamically from songs.json -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global songs configuration loaded from JSON
        let songsConfig = [];

        // Load songs configuration from JSON
        async function loadSongsConfig() {
            try {
                console.log('Loading songs from local data...');
                songsConfig = getSongsData();
                console.log('Successfully loaded songs config with', songsConfig.length, 'songs');
                return songsConfig;
            } catch (error) {
                console.error('Failed to load songs configuration:', error);
                songsConfig = [];
                return songsConfig;
            }
        }


        // Helper function to get display name for variation
        function getVariationDisplayName(variation) {
            if (variation.name) {
                return variation.name;
            }

            switch (variation.type) {
                case 'original':
                    return 'Original';
                case 'vocal':
                    return 'Vocal isolado';
                case 'playback':
                    return 'Playback';
                case 'voice':
                    switch (variation.subtype) {
                        case 'soprano':
                            return 'Soprano';
                        case 'contralto':
                            return 'Contralto';
                        case 'tenor':
                            return 'Tenor';
                        case 'tenor1':
                            return '1º Tenor (agudo)';
                        case 'tenor2':
                            return '2º Tenor (grave)';
                        case 'baixo':
                            return 'Baixo';
                        default:
                            return 'Voice';
                    }
                default:
                    return 'Audio';
            }
        }

        // Helper function to get icon for variation
        function getVariationIcon(variation) {
            switch (variation.type) {
                case 'original':
                    return '🎵';
                case 'vocal':
                    return '🎙️';
                case 'playback':
                    return '🎤';
                case 'voice':
                    return '🎶';
                default:
                    return '🎵';
            }
        }

        // Normalize song names for use as HTML IDs and CSS selectors
        function normalizeSongId(songName, songNumber) {
            // Use song number as base if available
            if (songNumber) {
                return `song_${songNumber}`;
            }

            // Fallback: normalize the song name
            return songName
                .toLowerCase()
                .replace(/[áàâãä]/g, 'a')
                .replace(/[éèêë]/g, 'e')
                .replace(/[íìîï]/g, 'i')
                .replace(/[óòôõö]/g, 'o')
                .replace(/[úùûü]/g, 'u')
                .replace(/[ç]/g, 'c')
                .replace(/[^\w]/g, '_')  // Replace non-word characters with underscore
                .replace(/_{2,}/g, '_')  // Replace multiple underscores with single
                .replace(/^_|_$/g, '');  // Remove leading/trailing underscores
        }

        // Generate playlist tracks from config
        function generatePlaylistTracks() {
            return songsConfig.map(song => {
                const originalVariation = song.variations.find(v => v.type === 'original');
                return {
                    title: song.name,
                    src: originalVariation ? originalVariation.src : '',
                    songConfig: song
                };
            });
        }

        function showSong(songNumber) {
            // Hide all song details
            hideSongs();

            // Stop all audio first
            stopAllAudio();

            // Hide the songs grid and title
            document.querySelector('.songs-grid').style.display = 'none';
            document.getElementById('songs-title').style.display = 'none';

            // Show the selected song
            const songElement = document.getElementById('song' + songNumber);
            if (songElement) {
                songElement.classList.add('active');

                // Smooth scroll to the song details
                songElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }

        function hideSongs() {
            // Stop all audio first
            stopAllAudio();

            const allSongs = document.querySelectorAll('.song-details');
            allSongs.forEach(song => {
                song.classList.remove('active');
            });

            // Show the songs grid and title again
            document.querySelector('.songs-grid').style.display = 'grid';
            document.getElementById('songs-title').style.display = 'block';
        }

        function stopAllAudio() {
            const audioPlayers = document.querySelectorAll('.audioPlayer');
            audioPlayers.forEach(audio => {
                audio.pause();
                audio.currentTime = 0;
            });

            // Remove playing class from all audio items and buttons
            const audioItems = document.querySelectorAll('.audio-item');
            const playButtons = document.querySelectorAll('.play-btn');
            audioItems.forEach(item => {
                item.classList.remove('playing');
                // Remove playing icon from title
                const playingIcon = item.querySelector('.playing-icon');
                if (playingIcon) {
                    playingIcon.remove();
                }
            });
            playButtons.forEach(btn => {
                btn.classList.remove('playing');
                btn.textContent = '▶';
            });
        }

        function stopAudioFromOtherSongs(currentAudioElement) {
            const currentSongDetails = currentAudioElement.closest('.song-details');

            // Get all song details except the current one
            const allSongDetails = document.querySelectorAll('.song-details');
            allSongDetails.forEach(songDetails => {
                if (songDetails !== currentSongDetails) {
                    // Stop all audio in this other song
                    const audioPlayers = songDetails.querySelectorAll('.audioPlayer');
                    audioPlayers.forEach(audio => {
                        audio.pause();
                        audio.currentTime = 0;
                    });

                    // Remove playing classes and icons from this other song
                    const audioItems = songDetails.querySelectorAll('.audio-item');
                    const playButtons = songDetails.querySelectorAll('.play-btn');
                    audioItems.forEach(item => {
                        item.classList.remove('playing');
                        const playingIcon = item.querySelector('.playing-icon');
                        if (playingIcon) {
                            playingIcon.remove();
                        }
                    });
                    playButtons.forEach(btn => {
                        btn.classList.remove('playing');
                        btn.textContent = '▶';
                    });
                }
            });
        }

        // Audio control functionality (fast forward and rewind)
        function setupAudioControls() {
            const ffButtons = document.querySelectorAll('.ff-btn');
            const rwButtons = document.querySelectorAll('.rw-btn');

            // Setup fast forward buttons
            ffButtons.forEach(btn => {
                setupButton(btn, 'forward');
            });

            // Setup rewind buttons
            rwButtons.forEach(btn => {
                setupButton(btn, 'rewind');
            });
        }

        function setupButton(btn, direction) {
            const audioPlayer = btn.closest('.audio-item').querySelector('audio');
            let holdTimer = null;
            let actionInterval = null;
            let tapCount = 0;
            let tapTimer = null;
            let isHolding = false;

            // Handle double tap for 10s skip/rewind
            const handleTap = () => {
                tapCount++;

                if (tapCount === 1) {
                    tapTimer = setTimeout(() => {
                        tapCount = 0;
                    }, 300);
                } else if (tapCount === 2) {
                    // Double tap - skip/rewind 10 seconds
                    clearTimeout(tapTimer);
                    tapCount = 0;
                    if (direction === 'forward') {
                        audioPlayer.currentTime = Math.min(audioPlayer.currentTime + 10, audioPlayer.duration || 0);
                    } else {
                        audioPlayer.currentTime = Math.max(audioPlayer.currentTime - 10, 0);
                    }
                }
            };

            // Start holding for continuous action
            const startHold = () => {
                isHolding = true;
                holdTimer = setTimeout(() => {
                    if (isHolding) {
                        actionInterval = setInterval(() => {
                            if (direction === 'forward') {
                                if (audioPlayer.currentTime < (audioPlayer.duration || 0)) {
                                    audioPlayer.currentTime = Math.min(audioPlayer.currentTime + 1, audioPlayer.duration || 0);
                                } else {
                                    clearInterval(actionInterval);
                                }
                            } else {
                                if (audioPlayer.currentTime > 0) {
                                    audioPlayer.currentTime = Math.max(audioPlayer.currentTime - 1, 0);
                                } else {
                                    clearInterval(actionInterval);
                                }
                            }
                        }, 100);
                    }
                }, 500); // Start continuous after 500ms hold
            };

            const stopHold = () => {
                isHolding = false;
                clearTimeout(holdTimer);
                clearInterval(actionInterval);
            };

            // Mouse events
            btn.addEventListener('click', handleTap);
            btn.addEventListener('mousedown', startHold);
            btn.addEventListener('mouseup', stopHold);
            btn.addEventListener('mouseleave', stopHold);

            // Touch events
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault(); // Prevent mouse events from firing
                handleTap();
                startHold();
            });
            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopHold();
            });
            btn.addEventListener('touchcancel', stopHold);
        }

        // Add click event to stop audio when clicking outside
        document.addEventListener('click', function(e) {
            // If clicking on a song card, don't stop audio
            if (e.target.closest('.song-card')) {
                return;
            }

            // If clicking on audio controls, don't stop audio
            if (e.target.closest('.audio-item') || e.target.closest('.audio-controls')) {
                return;
            }
        });

        // Check if audio file exists and hide item if not
        function checkAudioFile(audioElement) {
            const audioItem = audioElement.closest('.audio-item');
            const audioSrc = audioElement.src;

            // Skip if this is not a regular audio item (e.g., playlist audio)
            if (!audioItem) {
                return;
            }

            // Use fetch to check if file exists (works better on mobile)
            fetch(audioSrc, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        audioItem.style.display = 'block';
                    } else {
                        audioItem.style.display = 'none';
                    }
                })
                .catch(error => {
                    // File doesn't exist or network error
                    audioItem.style.display = 'none';
                });

            // Fallback: also listen for audio error events
            audioElement.addEventListener('error', function() {
                if (audioItem) {
                    audioItem.style.display = 'none';
                }
            });
        }

        // Custom audio player functionality
        function createCustomAudioPlayer(audioElement) {
            // Create custom player HTML if it doesn't exist
            if (!audioElement.nextElementSibling || !audioElement.nextElementSibling.classList.contains('custom-audio-player')) {
                const customPlayer = document.createElement('div');
                customPlayer.className = 'custom-audio-player';
                customPlayer.innerHTML = `
                    <div class="audio-progress-row">
                        <div class="progress-container">
                            <div class="progress-bar"></div>
                            <div class="progress-thumb"></div>
                        </div>
                    </div>
                    <div class="audio-controls-row">
                        <div class="audio-time">0:00 / 0:00</div>
                        <div class="audio-controls">
                            <button class="custom-rw-btn">&lt;&lt;</button>
                            <button class="play-btn">▶</button>
                            <button class="custom-ff-btn">&gt;&gt;</button>
                        </div>
                        <div class="volume-control">
                            <button class="volume-btn">🔊</button>
                        </div>
                    </div>
                `;
                audioElement.parentNode.insertBefore(customPlayer, audioElement.nextSibling);
            }

            const customPlayer = audioElement.nextElementSibling;
            const progressContainer = customPlayer.querySelector('.progress-container');
            const progressBar = customPlayer.querySelector('.progress-bar');
            const progressThumb = customPlayer.querySelector('.progress-thumb');
            const timeDisplay = customPlayer.querySelector('.audio-time');
            const playBtn = customPlayer.querySelector('.play-btn');
            const rwBtn = customPlayer.querySelector('.custom-rw-btn');
            const ffBtn = customPlayer.querySelector('.custom-ff-btn');
            const volumeBtn = customPlayer.querySelector('.volume-btn');

            let isDragging = false;

            // Update progress and time
            function updateProgress() {
                if (!isDragging && audioElement.duration) {
                    const progress = (audioElement.currentTime / audioElement.duration) * 100;
                    progressBar.style.width = progress + '%';
                    progressThumb.style.left = progress + '%';
                }

                const current = formatTime(audioElement.currentTime || 0);
                const total = formatTime(audioElement.duration || 0);
                timeDisplay.textContent = `${current} / ${total}`;
            }

            // Format time helper
            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            // Progress bar click/drag functionality
            function updateAudioTime(e) {
                const rect = progressContainer.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                const newTime = percent * audioElement.duration;
                if (newTime >= 0 && newTime <= audioElement.duration) {
                    audioElement.currentTime = newTime;
                    updateProgress();
                }
            }

            progressContainer.addEventListener('click', updateAudioTime);

            progressThumb.addEventListener('mousedown', (e) => {
                isDragging = true;
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    updateAudioTime(e);
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            // Touch events for mobile
            progressThumb.addEventListener('touchstart', (e) => {
                isDragging = true;
                e.preventDefault();
            });

            document.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    const touch = e.touches[0];
                    updateAudioTime(touch);
                }
            });

            document.addEventListener('touchend', () => {
                isDragging = false;
            });

            // Get song info for media session
            function getSongInfo(audioElement) {
                const audioItem = audioElement.closest('.audio-item');
                const songDetails = audioElement.closest('.song-details');
                const songTitle = songDetails ? songDetails.querySelector('h3').textContent : 'Musical de Natal 2025';
                const audioType = audioItem ? audioItem.querySelector('h4').textContent : '';

                return {
                    title: `${songTitle} - ${audioType}`,
                    artist: 'Musical de Natal 2025',
                    album: 'Natal 2025'
                };
            }

            // Update media session metadata
            function updateMediaSession(audioElement) {
                if ('mediaSession' in navigator) {
                    const songInfo = getSongInfo(audioElement);
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: songInfo.title,
                        artist: songInfo.artist,
                        album: songInfo.album,
                        artwork: [
                            { src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🎄</text></svg>', sizes: '96x96', type: 'image/svg+xml' }
                        ]
                    });

                    // Set up media session action handlers
                    navigator.mediaSession.setActionHandler('play', () => {
                        audioElement.play();
                    });
                    navigator.mediaSession.setActionHandler('pause', () => {
                        audioElement.pause();
                    });
                    navigator.mediaSession.setActionHandler('seekbackward', () => {
                        audioElement.currentTime = Math.max(audioElement.currentTime - 10, 0);
                    });
                    navigator.mediaSession.setActionHandler('seekforward', () => {
                        audioElement.currentTime = Math.min(audioElement.currentTime + 10, audioElement.duration || 0);
                    });
                }
            }

            // Play/pause button
            playBtn.addEventListener('click', () => {
                if (audioElement.paused) {
                    // Stop audio from other songs only (not same song)
                    stopAudioFromOtherSongs(audioElement);
                    updateMediaSession(audioElement);
                    audioElement.play();
                    playBtn.textContent = '⏸';
                    playBtn.classList.add('playing');
                    const audioItem = audioElement.closest('.audio-item');
                    if (audioItem) {
                        audioItem.classList.add('playing');
                        // Add playing icon to title
                        const title = audioItem.querySelector('h4');
                        if (title && !title.querySelector('.playing-icon')) {
                            title.innerHTML += ' <span class="playing-icon">🔊</span>';
                        }
                    }
                } else {
                    audioElement.pause();
                    playBtn.textContent = '▶';
                    playBtn.classList.remove('playing');
                    const audioItem = audioElement.closest('.audio-item');
                    if (audioItem) {
                        audioItem.classList.remove('playing');
                        // Remove playing icon from title
                        const playingIcon = audioItem.querySelector('.playing-icon');
                        if (playingIcon) {
                            playingIcon.remove();
                        }
                    }
                }
            });

            // Audio events
            audioElement.addEventListener('loadedmetadata', updateProgress);
            audioElement.addEventListener('timeupdate', updateProgress);
            audioElement.addEventListener('ended', () => {
                playBtn.textContent = '▶';
                playBtn.classList.remove('playing');
                const audioItem = audioElement.closest('.audio-item');
                if (audioItem) {
                    audioItem.classList.remove('playing');
                    // Remove playing icon from title
                    const playingIcon = audioItem.querySelector('.playing-icon');
                    if (playingIcon) {
                        playingIcon.remove();
                    }
                }
            });
            audioElement.addEventListener('pause', () => {
                playBtn.textContent = '▶';
                playBtn.classList.remove('playing');
                const audioItem = audioElement.closest('.audio-item');
                if (audioItem) {
                    audioItem.classList.remove('playing');
                    // Remove playing icon from title
                    const playingIcon = audioItem.querySelector('.playing-icon');
                    if (playingIcon) {
                        playingIcon.remove();
                    }
                }
            });
            audioElement.addEventListener('play', () => {
                playBtn.textContent = '⏸';
                playBtn.classList.add('playing');
                const audioItem = audioElement.closest('.audio-item');
                if (audioItem) {
                    audioItem.classList.add('playing');
                    // Add playing icon to title
                    const title = audioItem.querySelector('h4');
                    if (title && !title.querySelector('.playing-icon')) {
                        title.innerHTML += ' <span class="playing-icon">🔊</span>';
                    }
                }
            });

            // Setup fast forward/rewind with existing logic
            setupCustomButton(rwBtn, 'rewind', audioElement);
            setupCustomButton(ffBtn, 'forward', audioElement);

            // Volume control
            let isMuted = false;
            volumeBtn.addEventListener('click', () => {
                if (isMuted) {
                    audioElement.volume = 1;
                    volumeBtn.textContent = '🔊';
                    isMuted = false;
                } else {
                    audioElement.volume = 0;
                    volumeBtn.textContent = '🔇';
                    isMuted = true;
                }
            });
        }

        // Modified setup button function for custom players
        function setupCustomButton(btn, direction, audioPlayer) {
            let holdTimer = null;
            let actionInterval = null;
            let tapCount = 0;
            let tapTimer = null;
            let isHolding = false;

            // Handle double tap for 10s skip/rewind
            const handleTap = () => {
                tapCount++;

                if (tapCount === 1) {
                    tapTimer = setTimeout(() => {
                        tapCount = 0;
                    }, 300);
                } else if (tapCount === 2) {
                    // Double tap - skip/rewind 10 seconds
                    clearTimeout(tapTimer);
                    tapCount = 0;
                    if (direction === 'forward') {
                        audioPlayer.currentTime = Math.min(audioPlayer.currentTime + 10, audioPlayer.duration || 0);
                    } else {
                        audioPlayer.currentTime = Math.max(audioPlayer.currentTime - 10, 0);
                    }
                }
            };

            // Start holding for continuous action
            const startHold = () => {
                isHolding = true;
                holdTimer = setTimeout(() => {
                    if (isHolding) {
                        actionInterval = setInterval(() => {
                            if (direction === 'forward') {
                                if (audioPlayer.currentTime < (audioPlayer.duration || 0)) {
                                    audioPlayer.currentTime = Math.min(audioPlayer.currentTime + 1, audioPlayer.duration || 0);
                                } else {
                                    clearInterval(actionInterval);
                                }
                            } else {
                                if (audioPlayer.currentTime > 0) {
                                    audioPlayer.currentTime = Math.max(audioPlayer.currentTime - 1, 0);
                                } else {
                                    clearInterval(actionInterval);
                                }
                            }
                        }, 100);
                    }
                }, 500); // Start continuous after 500ms hold
            };

            const stopHold = () => {
                isHolding = false;
                clearTimeout(holdTimer);
                clearInterval(actionInterval);
            };

            // Mouse events
            btn.addEventListener('click', handleTap);
            btn.addEventListener('mousedown', startHold);
            btn.addEventListener('mouseup', stopHold);
            btn.addEventListener('mouseleave', stopHold);

            // Touch events
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault(); // Prevent mouse events from firing
                handleTap();
                startHold();
            });
            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopHold();
            });
            btn.addEventListener('touchcancel', stopHold);
        }

        // Playlist functionality - now dynamic
        let playlistTracks = [];

        let currentTrackIndex = 0;
        let playlistAudio = null;
        let playlistPlayer = null;

        async function showPlaylist() {
            // Make sure songs config is loaded
            if (!songsConfig || songsConfig.length === 0) {
                console.log('Loading songs config...');
                await loadSongsConfig();
            }

            console.log('Songs config available:', songsConfig.length, 'songs');

            // Hide songs section
            document.querySelector('.songs-section').style.display = 'none';
            document.querySelector('.quick-links').style.display = 'none';

            // Add playlist mode class to container
            document.querySelector('.container').classList.add('playlist-mode');

            // Show playlist section
            document.getElementById('playlist-section').style.display = 'flex';

            // Generate playlist tracks from config
            playlistTracks = generatePlaylistTracks();

            // Generate and insert playlist HTML
            const playlistContainer = document.querySelector('.playlist-tracks');
            const playlistHTML = generatePlaylistHTML();
            playlistContainer.innerHTML = playlistHTML;

            // Initialize playlist player
            playlistAudio = document.getElementById('playlist-audio');
            playlistPlayer = document.querySelector('#playlist-section .custom-audio-player');

            // Load first track (without auto-play)
            loadTrack(0);

            // Add auto-advance functionality
            playlistAudio.addEventListener('ended', () => {
                if (currentTrackIndex < playlistTracks.length - 1) {
                    loadTrack(currentTrackIndex + 1);
                    playlistAudio.play();
                } else {
                    // End of playlist
                    stopPlaylist();
                }
            });

            // Update status when play/pause changes
            playlistAudio.addEventListener('play', updateTrackStatus);
            playlistAudio.addEventListener('pause', updateTrackStatus);

            // Add track title click functionality (not the whole track)
            document.querySelectorAll('.playlist-track .track-title').forEach((trackTitle, index) => {
                trackTitle.addEventListener('click', () => {
                    loadTrack(index);
                    if (playlistAudio.paused) {
                        playlistAudio.play();
                    }
                });
            });

            // Add collapse button click functionality
            document.querySelectorAll('.collapse-btn').forEach((collapseBtn) => {
                collapseBtn.addEventListener('click', () => {
                    const trackIndex = parseInt(collapseBtn.getAttribute('data-track-index'));
                    toggleSubTracks(trackIndex);
                });
            });

            // Check which sub-track files exist and hide those that don't
            checkSubTrackFiles();
        }

        function hidePlaylist() {
            // Stop current audio
            if (playlistAudio) {
                playlistAudio.pause();
                playlistAudio.currentTime = 0;
            }

            // Remove playlist mode class from container
            document.querySelector('.container').classList.remove('playlist-mode');

            // Hide playlist section
            document.getElementById('playlist-section').style.display = 'none';

            // Show songs section
            document.querySelector('.songs-section').style.display = 'block';
            document.querySelector('.quick-links').style.display = 'block';
        }

        function stopPlaylist() {
            if (playlistAudio) {
                playlistAudio.pause();
                playlistAudio.currentTime = 0;
                updateTrackStatus();
            }
        }

        function loadTrack(index) {
            if (index >= 0 && index < playlistTracks.length) {
                currentTrackIndex = index;
                currentSubTrack = null; // Reset sub-track when loading main track
                const track = playlistTracks[index];

                playlistAudio.src = track.src;

                // Update current song display
                const songDisplay = document.getElementById('current-song-display');
                if (songDisplay) {
                    songDisplay.textContent = `${String(index + 1).padStart(2, '0')} - ${track.title}`;
                }

                // Close any expanded sub-tracks when switching songs
                if (currentExpandedTrack !== null) {
                    const prevTrack = playlistTracks[currentExpandedTrack];
                    const prevSongConfig = prevTrack.songConfig;
                    const prevNormalizedId = normalizeSongId(prevSongConfig.name, prevSongConfig.number);
                    const prevSubTracks = document.getElementById(`sub-tracks-${prevNormalizedId}`);
                    const prevCollapseBtn = document.querySelector(`[data-index="${currentExpandedTrack}"] .collapse-btn`);
                    if (prevSubTracks) {
                        prevSubTracks.style.display = 'none';
                        prevCollapseBtn.classList.remove('expanded');
                    }
                    currentExpandedTrack = null;
                }

                // Update media session
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: `${String(index + 1).padStart(2, '0')} - ${track.title}`,
                        artist: 'Musical de Natal 2025',
                        album: 'Natal 2025',
                        artwork: [
                            { src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🎄</text></svg>', sizes: '96x96', type: 'image/svg+xml' }
                        ]
                    });
                }

                updateTrackStatus();
                updateTrackHighlighting();
            }
        }

        function nextTrack() {
            if (currentTrackIndex < playlistTracks.length - 1) {
                loadTrack(currentTrackIndex + 1);
                if (playlistAudio && !playlistAudio.paused) {
                    playlistAudio.play();
                }
            } else {
                // End of playlist
                stopPlaylist();
            }
        }

        function previousTrack() {
            if (currentTrackIndex > 0) {
                loadTrack(currentTrackIndex - 1);
                if (playlistAudio && !playlistAudio.paused) {
                    playlistAudio.play();
                }
            }
        }

        function updateTrackStatus() {
            updateTrackHighlighting();
        }

        // Skip to next song function
        function skipToNext() {
            if (currentTrackIndex < playlistTracks.length - 1) {
                loadTrack(currentTrackIndex + 1);
                playlistAudio.play();
            }
        }

        // Skip to previous song function with double-tap logic
        let skipPrevTimeout = null;
        function skipToPrevious() {
            // If we're more than 3 seconds into the song, restart current song
            if (playlistAudio && playlistAudio.currentTime > 3) {
                playlistAudio.currentTime = 0;
                return;
            }

            // If we're within 3 seconds or at beginning, go to previous song
            if (currentTrackIndex > 0) {
                loadTrack(currentTrackIndex - 1);
                playlistAudio.play();
            } else {
                // If first song, just restart it
                if (playlistAudio) {
                    playlistAudio.currentTime = 0;
                }
            }
        }

        // Setup playlist player manually
        function setupPlaylistPlayer() {
            const progressContainer = playlistPlayer.querySelector('.progress-container');
            const progressBar = playlistPlayer.querySelector('.progress-bar');
            const progressThumb = playlistPlayer.querySelector('.progress-thumb');
            const timeDisplay = playlistPlayer.querySelector('.audio-time');
            const playBtn = playlistPlayer.querySelector('.play-btn');
            const rwBtn = playlistPlayer.querySelector('.custom-rw-btn');
            const ffBtn = playlistPlayer.querySelector('.custom-ff-btn');
            const volumeBtn = playlistPlayer.querySelector('.volume-btn');

            // Debug: Check if elements are found
            console.log('Play button found:', playBtn);
            console.log('Playlist audio element:', playlistAudio);

            // Guard: Make sure all required elements exist
            if (!playBtn || !playlistAudio || !progressContainer || !timeDisplay) {
                console.error('Missing required elements for playlist player setup');
                return;
            }

            let isDragging = false;

            // Update progress and time
            function updateProgress() {
                if (!isDragging && playlistAudio.duration) {
                    const progress = (playlistAudio.currentTime / playlistAudio.duration) * 100;
                    progressBar.style.width = progress + '%';
                    progressThumb.style.left = progress + '%';
                }

                const current = formatTime(playlistAudio.currentTime || 0);
                const total = formatTime(playlistAudio.duration || 0);
                timeDisplay.textContent = `${current} / ${total}`;
            }

            // Format time helper
            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            // Progress bar click/drag functionality
            function updateAudioTime(e) {
                const rect = progressContainer.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                const newTime = percent * playlistAudio.duration;
                if (newTime >= 0 && newTime <= playlistAudio.duration) {
                    playlistAudio.currentTime = newTime;
                    updateProgress();
                }
            }

            progressContainer.addEventListener('click', updateAudioTime);

            progressThumb.addEventListener('mousedown', (e) => {
                isDragging = true;
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    updateAudioTime(e);
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            // Touch events for mobile
            progressThumb.addEventListener('touchstart', (e) => {
                isDragging = true;
                e.preventDefault();
            });

            document.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    const touch = e.touches[0];
                    updateAudioTime(touch);
                }
            });

            document.addEventListener('touchend', () => {
                isDragging = false;
            });

            // Play/pause button
            playBtn.addEventListener('click', () => {
                if (playBtn.textContent == '▶') {
                    playlistAudio.play();
                    playBtn.textContent = '▶';
                    playBtn.classList.add('playing');
                    console.log('Started playing audio');
                } else {
                    playlistAudio.pause();
                    playBtn.textContent = '⏸';
                    playBtn.classList.remove('playing');
                    console.log('Paused audio');
                }
            });

            // Audio events
            playlistAudio.addEventListener('loadedmetadata', updateProgress);
            playlistAudio.addEventListener('timeupdate', updateProgress);
            playlistAudio.addEventListener('ended', () => {
                console.log('Audio ended');
                playBtn.textContent = '▶';
                playBtn.classList.remove('playing');
                updateTrackStatus();
            });
            playlistAudio.addEventListener('click', () => {
                if (playBtn.textContent == '▶') {
                    playlistAudio.play();
                    playBtn.textContent = '⏸';
                    playBtn.classList.add('playing');
                } else {
                    console.log('Audio paused');
                    playlistAudio.pause();
                    playBtn.textContent = '▶';
                    playBtn.classList.remove('playing');
                }
                
                updateTrackStatus();
            });
            playlistAudio.addEventListener('canplay', () => {
                console.log('Audio can play, duration:', playlistAudio.duration);
            });

            // Setup fast forward/rewind buttons
            setupCustomButton(rwBtn, 'rewind', playlistAudio);
            setupCustomButton(ffBtn, 'forward', playlistAudio);

            // Volume control
            let isMuted = false;
            volumeBtn.addEventListener('click', () => {
                if (isMuted) {
                    playlistAudio.volume = 1;
                    volumeBtn.textContent = '🔊';
                    isMuted = false;
                } else {
                    playlistAudio.volume = 0;
                    volumeBtn.textContent = '🔇';
                    isMuted = true;
                }
            });
        }

        // Playlist sub-tracks functionality
        let currentExpandedTrack = null;
        let currentSubTrack = null;

        // Generate playlist HTML dynamically from config
        function generatePlaylistHTML() {
            let html = '';

            playlistTracks.forEach((track, mainIndex) => {
                const songConfig = track.songConfig;
                const normalizedId = normalizeSongId(songConfig.name, songConfig.number);

                // Main track
                html += `
                    <div class="playlist-track" data-index="${mainIndex}" data-song-id="${normalizedId}">
                        <span class="track-number">${songConfig.number}</span>
                        <span class="track-title">${track.title}</span>
                        <button class="collapse-btn" data-track-index="${mainIndex}">▼</button>
                    </div>
                `;

                // Sub-tracks (excluding original)
                const nonOriginalVariations = songConfig.variations.filter(v => v.type !== 'original');
                if (nonOriginalVariations.length > 0) {
                    html += `<div class="sub-tracks" id="sub-tracks-${normalizedId}" style="display: none;">`;

                    nonOriginalVariations.forEach((variation, variationIndex) => {
                        // Find the actual index in the full variations array
                        const actualVariationIndex = songConfig.variations.indexOf(variation);
                        const displayName = getVariationDisplayName(variation);
                        const icon = getVariationIcon(variation);

                        html += `
                            <div class="sub-track" data-main-index="${mainIndex}" data-variation-index="${actualVariationIndex}">
                                <span class="sub-track-title">${icon} ${displayName}</span>
                            </div>
                        `;
                    });

                    html += '</div>';
                }
            });

            return html;
        }

        // Check if sub-track audio files exist and hide those that don't
        function checkSubTrackFiles() {
            playlistTracks.forEach((track, mainIndex) => {
                const songConfig = track.songConfig;

                songConfig.variations.forEach((variation, variationIndex) => {
                    if (variation.type !== 'original') {
                        const subTrackElement = document.querySelector(`[data-main-index="${mainIndex}"][data-variation-index="${variationIndex}"]`);
                        if (subTrackElement) {
                            // Check if file exists
                            fetch(variation.src, { method: 'HEAD' })
                                .then(response => {
                                    if (response.ok) {
                                        subTrackElement.style.display = 'flex';
                                    } else {
                                        subTrackElement.style.display = 'none';
                                    }
                                })
                                .catch(error => {
                                    subTrackElement.style.display = 'none';
                                });
                        }
                    }
                });
            });
        }

        function toggleSubTracks(trackIndex) {
            // Get the normalized ID for this track
            const track = playlistTracks[trackIndex];
            const songConfig = track.songConfig;
            const normalizedId = normalizeSongId(songConfig.name, songConfig.number);

            const subTracks = document.getElementById(`sub-tracks-${normalizedId}`);
            const collapseBtn = document.querySelector(`[data-index="${trackIndex}"] .collapse-btn`);

            // Close any previously expanded track
            if (currentExpandedTrack !== null && currentExpandedTrack !== trackIndex) {
                const prevTrack = playlistTracks[currentExpandedTrack];
                const prevSongConfig = prevTrack.songConfig;
                const prevNormalizedId = normalizeSongId(prevSongConfig.name, prevSongConfig.number);
                const prevSubTracks = document.getElementById(`sub-tracks-${prevNormalizedId}`);
                const prevCollapseBtn = document.querySelector(`[data-index="${currentExpandedTrack}"] .collapse-btn`);
                if (prevSubTracks) {
                    prevSubTracks.style.display = 'none';
                    prevCollapseBtn.classList.remove('expanded');
                }
            }

            // Toggle current track
            if (subTracks.style.display === 'none' || subTracks.style.display === '') {
                subTracks.style.display = 'block';
                collapseBtn.classList.add('expanded');
                currentExpandedTrack = trackIndex;

                // Add click listeners to sub-tracks
                const subTrackElements = subTracks.querySelectorAll('.sub-track');
                subTrackElements.forEach(subTrack => {
                    subTrack.addEventListener('click', () => {
                        const mainIndex = parseInt(subTrack.getAttribute('data-main-index'));
                        const variationIndex = parseInt(subTrack.getAttribute('data-variation-index'));
                        playSubTrack(mainIndex, variationIndex);
                    });
                });
            } else {
                subTracks.style.display = 'none';
                collapseBtn.classList.remove('expanded');
                currentExpandedTrack = null;
            }
        }

        function playSubTrack(mainIndex, variationIndex) {
            // Update current track index
            currentTrackIndex = mainIndex;
            currentSubTrack = variationIndex;

            // Get the track and variation from config
            const track = playlistTracks[mainIndex];
            const songConfig = track.songConfig;
            const variation = songConfig.variations[variationIndex];

            // Update audio source
            playlistAudio.src = variation.src;

            // Update current song display with variation name
            const songDisplay = document.getElementById('current-song-display');
            if (songDisplay) {
                const displayName = getVariationDisplayName(variation);
                songDisplay.textContent = `${songConfig.number} - ${track.title} - ${displayName}`;
            }

            // Update track highlighting
            updateTrackHighlighting();

            // Start playing
            playlistAudio.play();
        }

        function getFileNameFromSrc(src) {
            const parts = src.split('/');
            const fileName = parts[parts.length - 1];
            return fileName.replace('.mp3', '');
        }

        function getFileNumberFromSrc(src) {
            const fileName = getFileNameFromSrc(src);
            const match = fileName.match(/^(\d+)_/);
            return match ? match[1] : '01';
        }

        function updateTrackHighlighting() {
            // Clear all highlighting
            document.querySelectorAll('.playlist-track').forEach(track => {
                track.classList.remove('current');
            });
            document.querySelectorAll('.sub-track').forEach(subTrack => {
                subTrack.classList.remove('current');
            });

            // Highlight current main track
            const currentMainTrack = document.querySelector(`[data-index="${currentTrackIndex}"]`);
            if (currentMainTrack) {
                currentMainTrack.classList.add('current');
            }

            // Highlight current sub-track if any
            if (currentSubTrack !== null) {
                const currentSubTrackElement = document.querySelector(`[data-main-index="${currentTrackIndex}"][data-variation-index="${currentSubTrack}"]`);
                if (currentSubTrackElement) {
                    currentSubTrackElement.classList.add('current');
                }
            }
        }

        // Generate songs grid and details from JSON
        function generateSongsFromJSON() {
            if (!songsConfig || songsConfig.length === 0) {
                console.log('No songs configuration available');
                return;
            }

            // Generate songs grid
            const songsGrid = document.getElementById('songs-grid');
            if (songsGrid) {
                songsGrid.innerHTML = songsConfig.map((song, index) => `
                    <div class="song-card" onclick="showSong(${index + 1})">
                        <div class="song-content">
                            <div class="song-number">${song.number}</div>
                            <div class="song-title">${song.name}</div>
                        </div>
                    </div>
                `).join('');
            }

            // Generate song details
            const songDetailsContainer = document.getElementById('song-details-container');
            if (songDetailsContainer) {
                songDetailsContainer.innerHTML = songsConfig.map((song, index) => {
                    const audioItems = song.variations.map(variation => {
                        const displayName = getVariationDisplayName(variation);
                        return `
                            <div class="audio-item">
                                <h4>${displayName}</h4>
                                <audio class="audioPlayer" src="${variation.src}"></audio>
                                <div class="custom-audio-player">
                                    <div class="audio-progress-row">
                                        <div class="progress-container">
                                            <div class="progress-bar"></div>
                                            <div class="progress-thumb"></div>
                                        </div>
                                    </div>
                                    <div class="audio-controls-row">
                                        <div class="audio-time">0:00 / 0:00</div>
                                        <div class="audio-controls">
                                            <button class="custom-rw-btn">&lt;&lt;</button>
                                            <button class="play-btn">▶</button>
                                            <button class="custom-ff-btn">&gt;&gt;</button>
                                        </div>
                                        <div class="volume-control">
                                            <button class="volume-btn">🔊</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    return `
                        <div id="song${index + 1}" class="song-details">
                            <div class="song-header">
                                <button class="back-btn" onclick="hideSongs()">←</button>
                                <h3>${song.number} - ${song.name}</h3>
                                <button class="stop-all-btn" onclick="stopAllAudio()">⏹</button>
                            </div>
                            <div class="audio-list">
                                ${audioItems}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Setup audio players for newly created elements
            setTimeout(() => {
                const audioPlayers = document.querySelectorAll('.audioPlayer');
                audioPlayers.forEach(audio => {
                    createCustomAudioPlayer(audio);
                    checkAudioFile(audio);
                });
                setupAudioControls();
            }, 100);
        }

        // Initialize application
        async function initializeApp() {
            // Load songs configuration
            await loadSongsConfig();
            console.log('Songs configuration loaded:', songsConfig);

            // Generate songs from JSON
            generateSongsFromJSON();
        }

        // Improved mobile experience
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the app with JSON data
            initializeApp();

            // Add touch feedback for mobile
            if ('ontouchstart' in window) {
                const songCards = document.querySelectorAll('.song-card');
                songCards.forEach(card => {
                    card.addEventListener('touchstart', function() {
                        this.style.transform = 'scale(0.95)';
                    });

                    card.addEventListener('touchend', function() {
                        this.style.transform = '';
                    });
                });
            }
        });

        // Songs configuration data (moved from songs.json to avoid CORS issues)
        function getSongsData() {
            return [
                {
                    "name": "Isaías 9",
                    "number": "01",
                    "variations": [
                        {"type": "original", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/original/01_isaias_9.mp3"},
                        {"type": "vocal", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/voz/01_isaias_9-vocals.mp3"},
                        {"type": "playback", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/playback/01_isaias_9.mp3"},
                        {"type": "voice", "subtype": "soprano", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/01_isaias_9/01_soprano_isaias_9.mp3"},
                        {"type": "voice", "subtype": "contralto", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/01_isaias_9/01_contralto_isaias_9.mp3"},
                        {"type": "voice", "subtype": "tenor", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/01_isaias_9/01_tenor_isaias_9.mp3"},
                        {"type": "voice", "subtype": "baixo", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/01_isaias_9/01_baixo_isaias_9.mp3"}
                    ]
                },
                {
                    "name": "Maria",
                    "number": "02",
                    "variations": [
                        {"type": "original", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/original/02_maria.mp3"},
                        {"type": "vocal", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/voz/02_maria-vocals.mp3"},
                        {"type": "playback", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/playback/02_maria.mp3"},
                        {"type": "voice", "subtype": "soprano", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/02_maria/02_soprano_maria.mp3"},
                        {"type": "voice", "subtype": "contralto", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/02_maria/02_contralto_maria.mp3"},
                        {"type": "voice", "subtype": "tenor", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/02_maria/02_tenor_maria.mp3"},
                        {"type": "voice", "subtype": "baixo", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/02_maria/02_baixo_maria.mp3"}
                    ]
                },
                {
                    "name": "Noite Santa e Agnus Dei",
                    "number": "03",
                    "variations": [
                        {"type": "original", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/original/03_noite_santa_e_agnus_dei.mp3"},
                        {"type": "vocal", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/voz/03_noite_santa_e_agnus_dei-vocals.mp3"},
                        {"type": "playback", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/playback/03_noite_santa_e_agnus_dei.mp3"},
                        {"type": "voice", "subtype": "soprano", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/03_noite_santa_e_agnus_dei/03_soprano_noite_santa_e_agnus_dei.mp3"},
                        {"type": "voice", "subtype": "contralto", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/03_noite_santa_e_agnus_dei/03_contralto_noite_santa_e_agnus_dei.mp3"},
                        {"type": "voice", "subtype": "tenor", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/03_noite_santa_e_agnus_dei/03_tenor_noite_santa_e_agnus_dei.mp3"},
                        {"type": "voice", "subtype": "baixo", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/03_noite_santa_e_agnus_dei/03_baixo_noite_santa_e_agnus_dei.mp3"}
                    ]
                },
                {
                    "name": "Magos do Oriente",
                    "number": "04",
                    "variations": [
                        {"type": "original", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/original/04_magos_do_oriente.mp3"},
                        {"type": "vocal", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/voz/04_magos_do_oriente-vocals.mp3"},
                        {"type": "playback", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/playback/04_magos_do_oriente.mp3"}
                    ]
                },
                {
                    "name": "Isaías 53 e Foi na Cruz",
                    "number": "05",
                    "variations": [
                        {"type": "original", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/original/05_isaias_53_e_foi_na_cruz.mp3"},
                        {"type": "vocal", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/voz/05_isaias_53_e_foi_na_cruz-vocals.mp3"},
                        {"type": "playback", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/playback/05_isaias_53_e_foi_na_cruz.mp3"},
                        {"type": "voice", "subtype": "soprano", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/05_isaias_53_e_foi_na_cruz/05_soprano_isaias_53_e_foi_na_cruz.mp3"},
                        {"type": "voice", "subtype": "contralto", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/05_isaias_53_e_foi_na_cruz/05_contralto_isaias_53_e_foi_na_cruz.mp3"},
                        {"type": "voice", "subtype": "tenor", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/05_isaias_53_e_foi_na_cruz/05_tenor_isaias_53_e_foi_na_cruz.mp3"},
                        {"type": "voice", "subtype": "baixo", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/05_isaias_53_e_foi_na_cruz/05_baixo_isaias_53_e_foi_na_cruz.mp3"}
                    ]
                },
                {
                    "name": "O Leão e o Cordeiro",
                    "number": "06",
                    "variations": [
                        {"type": "original", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/original/06_o_leao_e_o_cordeiro.mp3"},
                        {"type": "vocal", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/voz/06_o_leao_e_o_cordeiro-vocals.mp3"},
                        {"type": "playback", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/playback/06_o_leao_e_o_cordeiro.mp3"},
                        {"type": "voice", "subtype": "soprano", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/06_o_leao_e_o_cordeiro/06_soprano_o_leao_e_o_cordeiro.mp3"},
                        {"type": "voice", "subtype": "contralto", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/06_o_leao_e_o_cordeiro/06_contralto_o_leao_e_o_cordeiro.mp3"},
                        {"type": "voice", "subtype": "tenor", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/06_o_leao_e_o_cordeiro/06_tenor_o_leao_e_o_cordeiro.mp3"},
                        {"type": "voice", "subtype": "baixo", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/06_o_leao_e_o_cordeiro/06_baixo_o_leao_e_o_cordeiro.mp3"}
                    ]
                },
                {
                    "name": "O Dia da Vitória",
                    "number": "07",
                    "variations": [
                        {"type": "original", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/original/07_o_dia_da_vitoria.mp3"},
                        {"type": "vocal", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/voz/07_o_dia_da_vitoria-vocals.mp3"},
                        {"type": "playback", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/playback/07_o_dia_da_vitoria.mp3"},
                        {"type": "voice", "subtype": "soprano", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/07_o_dia_da_vitoria/07_soprano_o_dia_da_vitoria.mp3"},
                        {"type": "voice", "subtype": "contralto", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/07_o_dia_da_vitoria/07_contralto_o_dia_da_vitoria.mp3"},
                        {"type": "voice", "subtype": "tenor", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/07_o_dia_da_vitoria/07_tenor_o_dia_da_vitoria.mp3"},
                        {"type": "voice", "subtype": "baixo", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/07_o_dia_da_vitoria/07_baixo_o_dia_da_vitoria.mp3"}
                    ]
                },
                {
                    "name": "Lhe Amostrando Jesus",
                    "number": "08",
                    "variations": [
                        {"type": "original", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/original/08_lhe_amostrando_jesus.mp3"},
                        {"type": "vocal", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/voz/08_lhe_amostrando_jesus-vocals.mp3"},
                        {"type": "playback", "subtype": null, "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/playback/08_lhe_amostrando_jesus.mp3"},
                        {"type": "voice", "subtype": "soprano", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/08_lhe_amostrando_jesus/08_soprano_lhe_amostrando_jesus.mp3"},
                        {"type": "voice", "subtype": "contralto", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/08_lhe_amostrando_jesus/08_contralto_lhe_amostrando_jesus.mp3"},
                        {"type": "voice", "subtype": "tenor1", "name": "1º Tenor (agudo)", "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/08_lhe_amostrando_jesus/08_tenor_1_lhe_amostrando_jesus.mp3"},
                        {"type": "voice", "subtype": "tenor2", "name": "2º Tenor (grave)", "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/08_lhe_amostrando_jesus/08_tenor_2_lhe_amostrando_jesus.mp3"},
                        {"type": "voice", "subtype": "baixo", "name": null, "src": "https://raw.githubusercontent.com/alanastone/natal2025/main/sources/divisao_voz/08_lhe_amostrando_jesus/08_baixo_lhe_amostrando_jesus.mp3"}
                    ]
                }
            ];
        }
    </script>
</body>
</html>